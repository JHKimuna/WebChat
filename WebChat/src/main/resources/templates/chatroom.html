<!DOCTYPE html>
<html
	lang="ko"
	xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:th="http://www.thymeleaf.org">

<head>
	<th:block th:include="fragments/head"></th:block>
	
	<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="/js/sockjs.min.js"></script>
	<script src="/js/stomp.min.js"></script>
	
	<link rel="stylesheet" href="/css/main.css"/>
	
	<style>
		div .left {
			width: 33%;
		}
		div .right {
			width: 33%;
		}
		div .center {
			width: 33%;
		}
	</style>

</head>

<body>
	<div class="app-container app-theme-white body-tabs-shadow fixed-sidebar fixed-header">

		<th:block th:include="fragments/header"></th:block>

		<div class="app-main">

			<th:block th:include="fragments/sidebar"></th:block>
		
			<div class="app-main__outer">
				<div class="app-main__inner">
					<div class="row">
						<div class="col-md-12">
							<div class="main-card mb-3 card">
								<div class="card-body">
								<div class="chat-header" id="container">
									<div class="left"></div>
									<div class="center"><h2><span th:text="${chatroom.name}"></span></h2></div>
									<div class="right">
										<button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#collapseX">&equiv;</button>
									</div>
								</div>
								
								<div class="connecting">
									Connecting...
								</div>
								
								<div class="collapse width" id="collapseX">
									<div style="width:250px; height:100%; background:green; position:absolute;"></div>
								</div>

								<div>
									<div class="scroll-area-lg left">
										<div class="scrollbar-container ps--active-y">
											<ul id="messageArea" style="overflow-y:hidden"></ul>
										</div>
									</div>
									
									<div class="scroll-area-lg right">
										<div class="scrollbar-container ps--active-y">
											<ul class="list-group" style="overflow-y:hidden">
												<li class="list-group-item-success list-group-item" th:each="user : ${users}">
													<span th:text="${user.name}"></span>
												</li>
											</ul>
										</div>
									</div>
								</div>
								
								<form id="messageForm" name="messageForm" th:object="${chatroom}" method="post">
								<div class="form-group">
									<div class="input-group clearfix">
										<input type="text" id="message" placeholder="Type a message..." autocomplete="off" class="form-control"/>
										<button type="submit" class="primary">Send</button>
									</div>
								</div>
							
						</form>
					</div></div></div></div>
				</div>
			</div>
		</div>
	</div>

<script th:inline="javascript">//<![CDATA[
		'use strict';
		
		var socket = null;
		//server 소켓의 endpoint인 /ws로 접속할 클라이언트  소켓 생성.
		var stompClient = null;
		var name = null;
		
		var connectingElement = document.querySelector(".connecting");
		var messageInput = document.querySelector("#message");
		 
		var currentRoomId = /*[[${chatroom.id}]]*/;
		var sessionUser = /*[[${user}]]*/;
		var messages = /*[[${messages}]]*/;
		var chatrooms = sessionUser.chatrooms;
		
		// DB에서 Message 읽어오기.
		$( document ).ready(function() {
	    	messages.forEach(function(element){
	    		var messageElement = document.createElement('li');
	    		if(message.type === 'JOIN') {
			        messageElement.classList.add('event-message');
			        element.contents = element.user.name + ' joined!';
			    } else if (message.type === 'LEAVE') {
			        messageElement.classList.add('event-message');
			        element.contents = element.user.name + ' left!';
			    } else {
			        messageElement.classList.add('chat-message');
	
			        var avatarElement = document.createElement('i');
			        var avatarText = document.createTextNode(element.user.name[0]);
			        avatarElement.appendChild(avatarText);
			        avatarElement.style['background-color'] = getAvatarColor(element.user.name);
			        // 아이콘 만들기
	
			        messageElement.appendChild(avatarElement);
	
			        var usernameElement = document.createElement('span');
			        var usernameText = document.createTextNode(element.user.name);
			        
			        var dateText = document.createElement('span');
			        var dateText = document.createTextNode("   " + element.chatTime.monthValue + "월 " + element.chatTime.dayOfMonth + "일 " + element.chatTime.hour + "시 " + element.chatTime.minute + "분");
			        
			        usernameElement.appendChild(usernameText);
			        messageElement.appendChild(usernameElement);
			        messageElement.appendChild(dateText);
			        // username 띄우기
			    }
		    
		    
		    
			    var textElement = document.createElement('p');
			    var messageText = document.createTextNode(element.contents);
			    textElement.appendChild(messageText);
			    // 메시지 내용 띄우기
	
			    messageElement.appendChild(textElement);
	
			    messageArea.appendChild(messageElement);
			    
			    // 추가하고, 스크롤 제일 밑으로 내리기
	    	});
	    	messageArea.scrollTop = messageArea.scrollHeight;
	    	
	    	$('#btnexit').click(function(){
		    	$('#messageForm').append("<input type='hidden' id='putOrDelete' name='_method' value='DELETE'/>");
		    	$('#messageForm').action="/chattings";
		    	$('#messageForm').submit();
		    });
		});
		
		if(sessionUser){
			name = sessionUser.name;
			var socket = new SockJS('/ws');
			stompClient = Stomp.over(socket);
			connectingElement.classList.add('hidden');
			stompClient.connect({}, onConnected, onError);
		}

		var colors = [
		    '#2196F3', '#32c787', '#00BCD4', '#ff5652',
		    '#ffc107', '#ff85af', '#FF9800', '#39bbb0'
		];
		
		function connect(event) {
			stompClient.connect({}, onConnected, onError);
			event.preventDefault();
		}


		function onConnected() {
			chatrooms.forEach(function(element) {
				stompClient.subscribe('/topic/' + element.id, onMessageReceived);
			});
			connectingElement.classList.add('hidden');
		}

		function onError(error) {
			connectingElement.textContent = 'Could not connect to WebSocket server. Please refresh this page to try again!';
		    connectingElement.style.color = 'red';
		}
		
		function sendMessage(event) {
		    var messageContent = messageInput.value.trim();
		    
		    if(messageContent && stompClient) {
		        var chatMessage = {
		        	senderId: sessionUser.id,
		            sender: name,
		            content: messageInput.value,
		            type: 'CHAT',
		            roomId: currentRoomId
		        };
		        stompClient.send("/app/chat.sendMessage/" + currentRoomId, {}, JSON.stringify(chatMessage));
		        messageInput.value = '';
		    }
		    
		    event.preventDefault();
		}


		function onMessageReceived(payload) {
			// 받은 메시지를 해석해서 메시지 창에 나오는 HTML 소스 추가
		    var message = JSON.parse(payload.body);

		    var messageElement = document.createElement('li');
		    
		    
		    if(currentRoomId == message.roomId) {
		    	
			    if(message.type === 'JOIN') {
			        messageElement.classList.add('event-message');
			        message.content = element.contents + ' joined!';
			    } else if (message.type === 'LEAVE') {
			        messageElement.classList.add('event-message');
			        message.content = message.sender + ' left!';
			    } else {
			        messageElement.classList.add('chat-message');
	
			        var avatarElement = document.createElement('i');
			        var avatarText = document.createTextNode(message.sender[0]);
			        avatarElement.appendChild(avatarText);
			        avatarElement.style['background-color'] = getAvatarColor(message.sender);
			        // 아이콘 만들기
	
			        messageElement.appendChild(avatarElement);
	
			        var usernameElement = document.createElement('span');
			        var dateElement = document.createElement('span');
			        // var usernameText = document.createTextNode(message.sender);
			        var nowDate = new Date();
			        var usernameText = document.createTextNode(message.sender + "   ");
			        var dateText = document.createTextNode(nowDate.getMonth() +1 + "월 " + nowDate.getDate() + "일 " + nowDate.getHours() + "시 " + nowDate.getMinutes() + "분");
			        usernameElement.appendChild(usernameText);
			        dateElement.appendChild(dateText);
			        messageElement.appendChild(usernameElement);
			        // username 띄우기
			        messageElement.appendChild(dateText);
			    }
		    
		    var textElement = document.createElement('p');
		    var messageText = document.createTextNode(message.content);
		    textElement.appendChild(messageText);
		    // 메시지 내용 띄우기

		    messageElement.appendChild(textElement);

		    messageArea.appendChild(messageElement);
		    messageArea.scrollTop = messageArea.scrollHeight;
		    // 추가하고, 스크롤 제일 밑으로 내리기
		    }
		}


		function getAvatarColor(messageSender) {
		    var hash = 0;
		    for (var i = 0; i < messageSender.length; i++) {
		        hash = 31 * hash + messageSender.charCodeAt(i);
		    }
		    var index = Math.abs(hash % colors.length);
		    return colors[index];
		    // 아바타 색 랜덤 지정
		}
		
		function exit() {
			form.action="/chattings";
			form.setAttribute('method', 'delete');
			form.submit();
		}

		function formatDate(date) {
			return 
			date.getHours() + '시 ' + 
			date.getMinutes() + '분';
		}
		
		var messageForm = document.querySelector('#messageForm');
		messageForm.addEventListener('submit', sendMessage, true) 
		//]]></script>
		
<script type="text/javascript" src="/assets/scripts/main.js"></script>
<script src="/js/user.js"></script>
<script src="/js/chatroom.js"></script>
<script>
	document.title = "채팅방" ;
</script>
</body> 
</html>
